<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Boublok - HTML & p5.js Editor</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material-darker.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/show-hint.min.css">

<style>
  * { box-sizing: border-box; }
  body {
    font-family: Arial, sans-serif;
    background-color: #f4f4f4;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    height: 100vh;
    overflow: hidden;
  }
  .editor-buttons {
    display: flex;
    justify-content: space-between;
    padding: 10px;
    background-color: #007bff;
    color: white;
    flex-shrink: 0;
  }
  .editor-buttons button {
    padding: 10px 20px;
    border: none;
    background-color: #007bff;
    color: white;
    cursor: pointer;
  }
  .editor-buttons button:hover { background-color: #0056b3; }

  .editor-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .editor {
    flex: 1;
    display: flex;
    overflow: hidden; /* Prevents stretching */
    background: #ddd;
  }

  /* Draggable Divider */
  .resizer {
    width: 6px;
    cursor: col-resize;
    background: #444;
    transition: background 0.2s;
    z-index: 10;
  }
  .resizer:hover { background: #007bff; }

  .CodeMirror {
    width: 50%; /* Starting width */
    height: 100% !important;
    font-size: 14px;
  }
  
  iframe {
    flex: 1;
    border: none;
    background: white;
    height: 100%;
  }

  #console-panel {
    background: #111;
    color: #0f0;
    font-family: monospace;
    font-size: 12px;
    height: 150px;
    display: flex;
    flex-direction: column;
    border-top: 2px solid #444;
    flex-shrink: 0;
  }
  #console-header {
    background: #222;
    padding: 4px 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: #fff;
  }
  #console-output {
    flex: 1;
    overflow-y: auto;
    padding: 5px;
  }
</style>
</head>
<body>
  <div class="editor-buttons">
    <div>
      <button onclick="runCode()">Run</button>
      <button onclick="saveCode()">Save</button>
    </div>
    <button id="switch-btn" onclick="switchEditor()">Switch to p5.js</button>
  </div>

  <div class="editor-container">
    <div id="html-editor" class="editor">
      <textarea id="html-code"></textarea>
      <div class="resizer"></div>
      <iframe id="output" sandbox="allow-scripts allow-same-origin"></iframe>
    </div>

    <div id="p5-editor" class="editor" style="display: none;">
      <textarea id="p5-code"></textarea>
      <div class="resizer"></div>
      <iframe id="p5-output" sandbox="allow-scripts allow-same-origin"></iframe>
    </div>

    <div id="console-panel">
      <div id="console-header">
        Console
        <button id="clear-console" style="background:#444; color:white; border:none; padding:2px 8px; cursor:pointer;">Clear</button>
      </div>
      <div id="console-output"></div>
    </div>
  </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/htmlmixed/htmlmixed.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/css/css.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/xml/xml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/show-hint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/html-hint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closebrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closetag.min.js"></script>

<script>
// === Autocomplete for p5.js ===
function getHints(cm) {
  const p5Functions = ['setup','draw','createCanvas','background','fill','stroke','rect','ellipse','line','mouseX','mouseY','width','height','random','map'];
  const cursor = cm.getCursor();
  const line = cm.getLine(cursor.line);
  const start = cursor.ch;
  const word = line.slice(0, start).match(/[\w$]+$/);
  if (!word) return { list: [], from: CodeMirror.Pos(cursor.line, start) };
  const from = CodeMirror.Pos(cursor.line, start - word[0].length);
  const hints = p5Functions.filter(f => f.startsWith(word[0])).sort();
  return { list: hints, from: from };
}

// === Initialize Editors ===
const htmlEditor = CodeMirror.fromTextArea(document.getElementById('html-code'), {
  mode: 'htmlmixed', theme: 'material-darker', lineNumbers: true, 
  autoCloseBrackets: true, autoCloseTags: true,
  extraKeys: { "Ctrl-Space": "autocomplete" },
  hintOptions: { hint: CodeMirror.hint.html, alignWithWord: true }
});

const p5Editor = CodeMirror.fromTextArea(document.getElementById('p5-code'), {
  mode: 'javascript', theme: 'material-darker', lineNumbers: true,
  autoCloseBrackets: true,
  extraKeys: { "Ctrl-Space": "autocomplete" },
  hintOptions: { hint: getHints, alignWithWord: true }
});

// === Load Storage ===
htmlEditor.setValue(localStorage.getItem('html-code') || `<!DOCTYPE html>\n<html>\n<body>\n<h1>Hello, Boublok!</h1>\n<script>console.log("HTML console ready");<\/script>\n</body>\n</html>`);
p5Editor.setValue(localStorage.getItem('p5-code') || `function setup() {\n  createCanvas(400, 400);\n  console.log("p5.js console ready");\n}\nfunction draw() {\n  background(220);\n  ellipse(mouseX, mouseY, 50, 50);\n}`);

// === Draggable Divider Logic ===
function initResizers() {
  const resizers = document.querySelectorAll('.resizer');
  resizers.forEach(resizer => {
    const container = resizer.parentElement;
    const editorEl = container.querySelector('.CodeMirror');
    const iframeEl = container.querySelector('iframe');

    resizer.addEventListener('mousedown', (e) => {
      e.preventDefault();
      iframeEl.style.pointerEvents = 'none'; // Prevent iframe from stealing mouse
      document.addEventListener('mousemove', resize);
      document.addEventListener('mouseup', stopResize);
    });

    function resize(e) {
      const containerRect = container.getBoundingClientRect();
      const newWidth = ((e.clientX - containerRect.left) / containerRect.width) * 100;
      if (newWidth > 15 && newWidth < 85) {
        editorEl.style.width = `${newWidth}%`;
      }
    }

    function stopResize() {
      iframeEl.style.pointerEvents = 'auto';
      document.removeEventListener('mousemove', resize);
      document.removeEventListener('mouseup', stopResize);
      htmlEditor.refresh();
      p5Editor.refresh();
    }
  });
}

// === Console Logic ===
function getConsoleInjection() {
  return `<script>
    (function(){
      const parentWin = window.parent;
      function serialize(arg) {
        try { return (typeof arg === 'object') ? JSON.stringify(arg) : String(arg); }
        catch(e) { return String(arg); }
      }
      ['log','warn','error','info'].forEach(type => {
        const orig = console[type];
        console[type] = function() {
          orig.apply(console, arguments);
          parentWin.postMessage({ type: type, args: Array.from(arguments).map(serialize) }, '*');
        };
      });
    })();
  <\/script>`;
}

window.addEventListener('message', (event) => {
  if (!event.data || !event.data.type) return;
  const output = document.getElementById('console-output');
  const msg = document.createElement('div');
  msg.textContent = `[${event.data.type}] ${event.data.args.join(' ')}`;
  output.appendChild(msg);
  output.scrollTop = output.scrollHeight;
});

//  Run & Save 
var debounceTimer;
const runCodeDebounced = () => {
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(runCode, 500);
};

htmlEditor.on('change', () => { localStorage.setItem('html-code', htmlEditor.getValue()); runCodeDebounced(); });
p5Editor.on('change', () => { localStorage.setItem('p5-code', p5Editor.getValue()); runCodeDebounced(); });

function runCode() {
  const isHtml = document.getElementById('html-editor').style.display !== 'none';
  if (isHtml) {
    document.getElementById('output').srcdoc = getConsoleInjection() + htmlEditor.getValue();
  } else {
    const html = `<html><head><script src="https://cdn.jsdelivr.net/npm/p5@1.9.0/lib/p5.min.js"><\/script>${getConsoleInjection()}</head><body><script>${p5Editor.getValue()}<\/script></body></html>`;
    document.getElementById('p5-output').srcdoc = html;
  }
}

function switchEditor() {
  const htmlDiv = document.getElementById('html-editor');
  const p5Div = document.getElementById('p5-editor');
  const btn = document.getElementById('switch-btn');
  const isHtml = htmlDiv.style.display !== 'none';
  htmlDiv.style.display = isHtml ? 'none' : 'flex';
  p5Div.style.display = isHtml ? 'flex' : 'none';
  btn.textContent = isHtml ? 'Switch to HTML' : 'Switch to p5.js';
  isHtml ? p5Editor.refresh() : htmlEditor.refresh();
  runCode();
}

document.getElementById('clear-console').onclick = () => document.getElementById('console-output').innerHTML = '';

initResizers();
runCode();
</script>
</body>
</html>
