<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Boublok - HTML & p5.js Editor</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material-darker.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/show-hint.min.css">

<style>
  * { box-sizing: border-box; }
  body {
    font-family: Arial, sans-serif;
    background-color: #f4f4f4;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  .editor-buttons {
    display: flex;
    justify-content: space-between;
    padding: 10px;
    background-color: #007bff;
    color: white;
  }
  .editor-buttons button {
    padding: 10px 20px;
    border: none;
    background-color: #007bff;
    color: white;
    cursor: pointer;
  }
  .editor-buttons button:hover {
    background-color: #0056b3;
  }
  .editor-container {
    flex: 1;
    display: flex;
    flex-direction: column;
  }
  .editor {
    flex: 1;
    display: flex;
    gap: 1px;
    background: #ddd;
  }
  .CodeMirror {
    flex: 1;
    height: 100%;
    font-size: 14px;
  }
  iframe {
    flex: 1;
    border: none;
    margin: 0;
  }
  #console-panel {
    background: #111;
    color: #0f0;
    font-family: monospace;
    font-size: 12px;
    height: 150px;
    display: flex;
    flex-direction: column;
    border-top: 2px solid #444;
  }
  #console-header {
    background: #222;
    padding: 4px 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: #fff;
    font-weight: bold;
  }
  #console-output {
    flex: 1;
    overflow-y: auto;
    padding: 5px;
  }
  #clear-console {
    background: #444;
    color: white;
    border: none;
    padding: 4px 8px;
    font-size: 12px;
    cursor: pointer;
  }
  #clear-console:hover {
    background: #666;
  }
</style>
</head>
<body>
  <div class="editor-buttons">
    <button onclick="runCode()">Run</button>
    <button onclick="saveCode()">Save</button>
    <button id="switch-btn" onclick="switchEditor()">Switch to p5.js</button>
  </div>

  <div class="editor-container">
    <div id="html-editor" class="editor">
      <textarea id="html-code"></textarea>
      <iframe id="output" sandbox="allow-scripts allow-same-origin"></iframe>
    </div>
    <div id="p5-editor" class="editor" style="display: none;">
      <textarea id="p5-code"></textarea>
      <iframe id="p5-output" sandbox="allow-scripts allow-same-origin"></iframe>
    </div>

    <!-- Console Panel -->
    <div id="console-panel">
      <div id="console-header">
        Console
        <button id="clear-console">Clear</button>
      </div>
      <div id="console-output"></div>
    </div>
  </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/htmlmixed/htmlmixed.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/css/css.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/xml/xml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/show-hint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/html-hint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/javascript-hint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closebrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closetag.min.js"></script>

<script>
 // === Autocomplete for p5.js ===
function getHints(cm) {
  const p5Functions = [
    'setup','draw','createCanvas','background','fill','stroke','noFill','noStroke',
    'rect','ellipse','line','point','triangle','quad','curve','bezier','arc',
    'beginShape','endShape','vertex','push','pop','translate','rotate','scale',
    'mouseX','mouseY','pmouseX','pmouseY','width','height','random','map',
    'constrain','abs','round','floor','ceil','int','float','text','textSize',
    'textFont','textLeading','textStyle','textWidth'
  ];
  const cursor = cm.getCursor();
  const line = cm.getLine(cursor.line);
  const start = cursor.ch;
  const word = line.slice(0, start).match(/[\w$]+$/);
  if (!word) return { list: [], from: CodeMirror.Pos(cursor.line, start) };
  const from = CodeMirror.Pos(cursor.line, start - word[0].length);
  const hints = p5Functions.filter(f => f.startsWith(word[0])).sort();
  return { list: hints, from: from };
}

// === CodeMirror editors ===
const htmlEditor = CodeMirror.fromTextArea(document.getElementById('html-code'), {
  mode: 'htmlmixed', theme: 'material-darker', lineNumbers: true, tabSize: 2,
  autoCloseBrackets: true, autoCloseTags: true,
  extraKeys: { "Ctrl-Space": "autocomplete" },
  hintOptions: { hint: CodeMirror.hint.html, alignWithWord: true }
});
const p5Editor = CodeMirror.fromTextArea(document.getElementById('p5-code'), {
  mode: 'javascript', theme: 'material-darker', lineNumbers: true, tabSize: 2,
  autoCloseBrackets: true,
  extraKeys: { "Ctrl-Space": "autocomplete" },
  hintOptions: { hint: getHints, alignWithWord: true }
});

// === Load saved code or defaults ===
htmlEditor.setValue(localStorage.getItem('html-code') || 
`<!DOCTYPE html>
<html>
<body>
<h1>Hello, Boublok!</h1>
<script>
console.log("HTML console ready");
<\/script>
</body>
</html>`);

p5Editor.setValue(localStorage.getItem('p5-code') || 
`function setup() {
  createCanvas(400, 400);
  console.log("p5.js console ready");
}
function draw() {
  background(220);
  ellipse(mouseX, mouseY, 50, 50);
}`);

// === Debounced run ===
let debounceTimer;
const runCodeDebounced = () => {
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(runCode, 500);
};
htmlEditor.on('change', () => { localStorage.setItem('html-code', htmlEditor.getValue()); runCodeDebounced(); });
p5Editor.on('change', () => { localStorage.setItem('p5-code', p5Editor.getValue()); runCodeDebounced(); });

// === Clear console button ===
document.getElementById('clear-console').addEventListener('click', () => {
  document.getElementById('console-output').innerHTML = '';
});

// === Console injection script (runs before user code) ===
function getConsoleInjection() {
  return `
<script>
(function(){
  const parentConsole = window.parent;

  function serializeArg(arg) {
    if (arg instanceof Error) {
      return arg.name + ": " + arg.message + "\\n" + arg.stack;
    }
    if (typeof arg === 'object') {
      try { return JSON.stringify(arg); }
      catch(e) { return String(arg); }
    }
    return String(arg);
  }

  function sendToParent(type, args) {
    parentConsole.postMessage({
      type: type,
      args: Array.from(args).map(serializeArg)
    }, '*');
  }

  // Override console methods
  ['log','warn','error','info'].forEach(type => {
    const orig = console[type];
    console[type] = function() {
      orig.apply(console, arguments);
      sendToParent(type, arguments);
    };
  });

  // Capture uncaught errors
  window.onerror = function(message, source, lineno, colno, error) {
    sendToParent('error', [message + " (" + source + ":" + lineno + ":" + colno + ")", error && error.stack ? error.stack : '']);
  };

  // Capture unhandled promise rejections
  window.addEventListener('unhandledrejection', function(event) {
    sendToParent('error', ['Unhandled Promise Rejection:', event.reason]);
  });
})();
<\/script>
`;
}


// === Parent listener for iframe messages ===
window.addEventListener('message', (event) => {
  if (!event.data || !event.data.type) return;
  const output = document.getElementById('console-output');
  const msg = document.createElement('div');
  msg.textContent = `[${event.data.type}] ${event.data.args.join(' ')}`;
  output.appendChild(msg);
  output.scrollTop = output.scrollHeight;
});

// === Run code in iframe ===
function runCode() {
  const isHtmlVisible = document.getElementById('html-editor').style.display !== 'none';
  if (isHtmlVisible) {
    // Inject console before user HTML
    document.getElementById('output').srcdoc =
      getConsoleInjection() + htmlEditor.getValue();
  } else {
    const code = p5Editor.getValue();
    const html = `
<!doctype html>
<html>
<head>
<meta charset="utf-8">
<style>html,body{margin:0;padding:0;}</style>
<script src="https://cdn.jsdelivr.net/npm/p5@1.9.0/lib/p5.min.js"><\/script>
${getConsoleInjection()}
</head>
<body>
<script>
${code}
<\/script>
</body>
</html>`;
    document.getElementById('p5-output').srcdoc = html;
  }
}

// === Save code to file ===
function saveCode() {
  const isHtmlVisible = document.getElementById('html-editor').style.display !== 'none';
  if (isHtmlVisible) {
    download('code.html', htmlEditor.getValue(), 'text/html');
  } else {
    const code = p5Editor.getValue();
    const html = `
<!doctype html>
<html><head><meta charset="utf-8">
<script src="https://cdn.jsdelivr.net/npm/p5@1.9.0/lib/p5.min.js"><\/script>
</head><body>
<script>
${code}
<\/script>
</body></html>`;
    download('code-p5.html', html, 'text/html');
  }
}

function download(filename, content, type) {
  const blob = new Blob([content], { type });
  const a = Object.assign(document.createElement('a'), {
    href: URL.createObjectURL(blob),
    download: filename
  });
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(() => URL.revokeObjectURL(a.href), 0);
}

// === Switch between HTML and p5.js editors ===
function switchEditor() {
  const htmlDiv = document.getElementById('html-editor');
  const p5Div = document.getElementById('p5-editor');
  const button = document.getElementById('switch-btn');

  const htmlVisible = htmlDiv.style.display !== 'none';
  htmlDiv.style.display = htmlVisible ? 'none' : 'flex';
  p5Div.style.display = htmlVisible ? 'flex' : 'none';
  button.textContent = htmlVisible ? 'Switch to HTML' : 'Switch to p5.js';

  runCodeDebounced();
}

// === Keyboard shortcut: Ctrl/Cmd + Enter ===
document.addEventListener('keydown', (e) => {
  if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
    e.preventDefault();
    runCode();
  }
});

// === Initial run ===
runCode();

</script>
</body>
</html>
