<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StenoSlides - Stenoip Company</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <style>
        :root { --office-blue: rgb(255,150,80); --ribbon-gray: #f3f2f1; --border-color: #edebe9; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', sans-serif; overflow: hidden; background: #444; }
        
        /* Layout */
        .app-container { display: grid; grid-template-rows: 30px auto 1fr; grid-template-columns: 220px 1fr; height: 100vh; }
        .title-bar { grid-column: 1 / -1; background: var(--office-blue); color: #fff; padding: 5px 15px; font-size: 13px; display: flex; justify-content: space-between; align-items: center; }
        
        /* Ribbon */
        .ribbon { grid-column: 1 / -1; background: var(--ribbon-gray); border-bottom: 1px solid #ccc; z-index: 20; }
        .ribbon-tabs { display: flex; background: #fff; border-bottom: 1px solid #ddd; }
        .tab-btn { padding: 8px 15px; border: none; background: none; cursor: pointer; font-size: 12px; }
        .tab-btn.active { border-bottom: 3px solid var(--office-blue); font-weight: bold; }
        .ribbon-content { display: none; padding: 5px 10px; align-items: center; overflow-x: auto; }
        .ribbon-content.active { display: flex; }
        .control-group { display: flex; flex-direction: column; align-items: center; border-right: 1px solid #ccc; padding: 0 10px; margin-right: 5px; height: 60px; justify-content: center; }
        .group-label { font-size: 9px; color: #777; margin-top: 2px; }
        .btn-tool { background: none; border: 1px solid transparent; padding: 4px; cursor: pointer; border-radius: 3px; font-size: 11px; display: flex; flex-direction: column; align-items: center; min-width: 50px; }
        .btn-tool:hover { background: #d1d1d1; }
        .btn-tool i { font-size: 16px; margin-bottom: 2px; color: var(--office-blue); }

        /* Project Manager Sidebar */
        .sidebar { grid-row: 3; grid-column: 1; background: #fff; border-right: 1px solid #ddd; display: flex; flex-direction: column; }
        .project-selector { padding: 10px; border-bottom: 2px solid var(--office-blue); background: #f9f9f9; }
        .slide-list { flex-grow: 1; overflow-y: auto; padding: 10px; background: #eee; }
        .slide-thumb { width: 100%; aspect-ratio: 16/9; background: white; border: 2px solid #ccc; margin-bottom: 10px; cursor: pointer; position: relative; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .slide-thumb.active { border-color: var(--office-blue); box-shadow: 0 0 8px var(--office-blue); }

        /* Canvas Area */
        .workspace { grid-row: 3; grid-column: 2; display: flex; justify-content: center; align-items: center; position: relative; overflow: auto; }
        .canvas-container { box-shadow: 0 0 20px rgba(0,0,0,0.5); transition: transform 0.3s; }

        /* Fullscreen Presentation */
        canvas:-webkit-full-screen { width: 100vw !important; height: 100vh !important; }
        
        #mediaInput { display: none; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="title-bar">
        <span><i class="fas fa-layer-group"></i> <strong id="projNameDisplay">StenoSlides</strong></span>
        <span>Shortcuts: [Del] Delete, [Ctrl+S] Save, [N] New Slide, [F5] Present</span>
    </div>

    <div class="ribbon">
        <div class="ribbon-tabs">
            <button class="tab-btn active" onclick="switchTab('home')">Home</button>
            <button class="tab-btn" onclick="switchTab('insert')">Insert</button>
            <button class="tab-btn" onclick="switchTab('design')">Design</button>
            <button class="tab-btn" onclick="switchTab('projects')">File / Projects</button>
        </div>

        <div id="tab-home" class="ribbon-content active">
            <div class="control-group">
                <button class="btn-tool" onclick="addNewSlide()"><i class="fas fa-plus"></i>New Slide</button>
                <span class="group-label">Slides</span>
            </div>
            <div class="control-group">
                <div style="display:flex; gap:3px;">
                    <button class="btn-tool" onclick="execCmd('bold')" title="Bold"><i class="fas fa-bold"></i></button>
                    <button class="btn-tool" onclick="execCmd('italic')" title="Italic"><i class="fas fa-italic"></i></button>
                    <input type="color" id="fontColor" onchange="changeSelectionColor(this.value)" style="width:30px;height:30px;border:none;cursor:pointer">
                </div>
                <span class="group-label">Formatting</span>
            </div>
            <div class="control-group">
                <button class="btn-tool" onclick="deleteObject()"><i class="fas fa-trash"></i>Delete</button>
                <span class="group-label">Modify</span>
            </div>
        </div>

        <div id="tab-insert" class="ribbon-content">
            <button class="btn-tool" onclick="addTextbox()"><i class="fas fa-font"></i>Text</button>
            <button class="btn-tool" onclick="addShape('rect')"><i class="far fa-square"></i>Rect</button>
            <button class="btn-tool" onclick="addShape('circle')"><i class="far fa-circle"></i>Circle</button>
            <button class="btn-tool" onclick="triggerMedia()"><i class="fas fa-photo-video"></i>Media</button>
            <input type="file" id="mediaInput" accept="image/*,video/mp4" onchange="handleMediaUpload(event)">
        </div>

        <div id="tab-design" class="ribbon-content">
            <div class="control-group">
                <input type="color" id="slideColor" onchange="changeSlideColor(this.value)" style="width:40px;height:30px;">
                <span class="group-label">Slide Background</span>
            </div>
        </div>

        <div id="tab-projects" class="ribbon-content">
            <div class="control-group">
                <select id="projectSelect" onchange="switchProject(this.value)" style="padding:4px;"></select>
                <span class="group-label">Switch Project</span>
            </div>
            <button class="btn-tool" onclick="createNewProject()"><i class="fas fa-file-medical"></i>New Project</button>
            <button class="btn-tool" onclick="deleteCurrentProject()" style="color:red;"><i class="fas fa-folder-minus"></i>Delete Project</button>
            <button class="btn-tool" onclick="enterPresentMode()"><i class="fas fa-play"></i>Present (F5)</button>
        </div>
    </div>

    <div class="sidebar">
        <div class="project-selector">
            <small>Current Slides</small>
        </div>
        <div class="slide-list" id="slide-sorter"></div>
    </div>

    <div class="workspace" id="presentation-area" onclick="handlePresentationClick()">
        <canvas id="mainCanvas"></canvas>
    </div>
</div>

<script>
    /**
     * STENOSLIDES 
     */
    var canvas;
    var currentProjectName = "Default Project";
    var appState = {
        slides: [],
        currentSlideIndex: 0
    };

    function init() {
        canvas = new fabric.Canvas('mainCanvas', {
            width: 800,
            height: 450,
            backgroundColor: '#ffffff'
        });

        setupKeyboardShortcuts();
        loadProjectList();
        loadProject(currentProjectName);
        
        // Canvas click should not advance slide unless in fullscreen
        canvas.on('mouse:down', function(e) {
            if (document.fullscreenElement) {
                advanceSlide();
            }
        });
    }

    // PROJECT MANAGEMENT
    function loadProjectList() {
        var list = JSON.parse(localStorage.getItem('steno_project_list') || '["Default Project"]');
        var select = document.getElementById('projectSelect');
        select.innerHTML = '';
        var i;
        for (i = 0; i < list.length; i++) {
            var opt = document.createElement('option');
            opt.value = list[i];
            opt.innerHTML = list[i];
            select.appendChild(opt);
        }
        select.value = currentProjectName;
    }

    function createNewProject() {
        var name = prompt("Enter project name:");
        if (!name) return;
        var list = JSON.parse(localStorage.getItem('steno_project_list') || '[]');
        list.push(name);
        localStorage.setItem('steno_project_list', JSON.stringify(list));
        currentProjectName = name;
        appState = { slides: [], currentSlideIndex: 0 };
        addNewSlide();
        saveToStorage();
        loadProjectList();
    }

    function switchProject(name) {
        saveToStorage();
        currentProjectName = name;
        loadProject(name);
    }

    function deleteCurrentProject() {
        if (!confirm("Delete entire project?")) return;
        var list = JSON.parse(localStorage.getItem('steno_project_list') || '[]');
        var newList = list.filter(function(i) { return i !== currentProjectName; });
        localStorage.setItem('steno_project_list', JSON.stringify(newList));
        localStorage.removeItem('steno_proj_' + currentProjectName);
        location.reload();
    }

    function saveToStorage() {
        appState.slides[appState.currentSlideIndex].data = canvas.toJSON();
        localStorage.setItem('steno_proj_' + currentProjectName, JSON.stringify(appState));
        document.getElementById('projNameDisplay').innerText = currentProjectName + " (Saved)";
    }

    function loadProject(name) {
        var data = localStorage.getItem('steno_proj_' + name);
        if (data) {
            appState = JSON.parse(data);
            loadSlide(appState.currentSlideIndex || 0);
        } else {
            addNewSlide();
        }
        document.getElementById('projNameDisplay').innerText = currentProjectName;
    }

    // SLIDE LOGIC
    function addNewSlide() {
        var slide = { id: Date.now(), data: null, background: '#ffffff' };
        appState.slides.push(slide);
        loadSlide(appState.slides.length - 1);
    }

    function loadSlide(index) {
        if (appState.slides[appState.currentSlideIndex]) {
            appState.slides[appState.currentSlideIndex].data = canvas.toJSON();
        }
        appState.currentSlideIndex = index;
        canvas.clear();
        var slide = appState.slides[index];
        if (slide.data) {
            canvas.loadFromJSON(slide.data, function() {
                canvas.renderAll();
            });
        } else {
            canvas.setBackgroundColor('#ffffff', canvas.renderAll.bind(canvas));
        }
        renderThumbs();
    }

    function renderThumbs() {
        var container = document.getElementById('slide-sorter');
        container.innerHTML = '';
        var i;
        for (i = 0; i < appState.slides.length; i++) {
            var thumb = document.createElement('div');
            thumb.className = 'slide-thumb' + (i === appState.currentSlideIndex ? ' active' : '');
            thumb.onclick = (function(idx) { return function() { loadSlide(idx); }; })(i);
            container.appendChild(thumb);
        }
    }

    // TOOLS
    function addTextbox() {
        var t = new fabric.IText("Type Here", { left: 100, top: 100, fontFamily: 'Segoe UI' });
        canvas.add(t);
    }

    function addShape(type) {
        var s = (type === 'rect') ? new fabric.Rect({ width: 100, height: 100, fill: '#2b579a' }) : 
                                   new fabric.Circle({ radius: 50, fill: '#2b579a' });
        s.set({ left: 150, top: 150 });
        canvas.add(s);
    }

    function triggerMedia() { document.getElementById('mediaInput').click(); }

    function handleMediaUpload(e) {
        var file = e.target.files[0];
        var reader = new FileReader();
        reader.onload = function(f) {
            var data = f.target.result;
            if (file.type.indexOf('image') !== -1) {
                fabric.Image.fromURL(data, function(img) {
                    img.scaleToWidth(300);
                    canvas.add(img);
                });
            } else if (file.type.indexOf('video') !== -1) {
                var videoEl = document.createElement('video');
                videoEl.src = data;
                videoEl.loop = true;
                videoEl.muted = true;
                videoEl.play();
                var videoObj = new fabric.Image(videoEl, { left: 100, top: 100, width: 400, height: 225 });
                canvas.add(videoObj);
                fabric.util.requestAnimFrame(function render() {
                    canvas.renderAll();
                    fabric.util.requestAnimFrame(render);
                });
            }
        };
        reader.readAsDataURL(file);
    }

    function changeSlideColor(color) {
        canvas.setBackgroundColor(color, canvas.renderAll.bind(canvas));
        appState.slides[appState.currentSlideIndex].background = color;
    }

    function changeSelectionColor(color) {
        var obj = canvas.getActiveObject();
        if (obj) { obj.set('fill', color); canvas.renderAll(); }
    }

    function deleteObject() {
        var obj = canvas.getActiveObject();
        if (obj) canvas.remove(obj);
    }

    function execCmd(cmd) {
        var obj = canvas.getActiveObject();
        if (!obj || !obj.set) return;
        if (cmd === 'bold') obj.set('fontWeight', obj.fontWeight === 'bold' ? 'normal' : 'bold');
        if (cmd === 'italic') obj.set('fontStyle', obj.fontStyle === 'italic' ? 'normal' : 'italic');
        canvas.renderAll();
    }

    // PRESENTATION MODE
    function enterPresentMode() {
        var el = document.getElementById('presentation-area');
        if (el.requestFullscreen) el.requestFullscreen();
    }

    function advanceSlide() {
        if (appState.currentSlideIndex < appState.slides.length - 1) {
            loadSlide(appState.currentSlideIndex + 1);
        } else {
            if (document.exitFullscreen) document.exitFullscreen();
        }
    }

    function handlePresentationClick() {
        if (document.fullscreenElement) advanceSlide();
    }

    // SHORTCUTS
    function setupKeyboardShortcuts() {
        window.addEventListener('keydown', function(e) {
            // Delete key
            if (e.key === "Delete" || e.key === "Backspace") {
                if (!canvas.getActiveObject() || canvas.getActiveObject().isEditing) return;
                deleteObject();
            }
            // Ctrl + S (Save)
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveToStorage();
                alert("Project Saved to Browser Storage");
            }
            // N (New Slide)
            if (e.key.toLowerCase() === 'n' && !e.ctrlKey) {
                if (canvas.getActiveObject() && canvas.getActiveObject().isEditing) return;
                addNewSlide();
            }
            // F5 (Present)
            if (e.key === "F5") {
                e.preventDefault();
                enterPresentMode();
            }
            // Arrow Keys (Navigation)
            if (e.key === "ArrowRight" || e.key === "PageDown") advanceSlide();
            if (e.key === "ArrowLeft" || e.key === "PageUp") {
                if (appState.currentSlideIndex > 0) loadSlide(appState.currentSlideIndex - 1);
            }
        });
    }

    function switchTab(name) {
        var i, contents = document.getElementsByClassName('ribbon-content'), tabs = document.getElementsByClassName('tab-btn');
        for (i = 0; i < contents.length; i++) contents[i].classList.remove('active');
        for (i = 0; i < tabs.length; i++) tabs[i].classList.remove('active');
        document.getElementById('tab-' + name).classList.add('active');
        window.event.currentTarget.classList.add('active');
    }

    window.onload = init;
</script>

</body>
</html>
