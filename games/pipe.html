<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Rotate the Pipes</title>

<style>
body {
  margin: 0;
  background: #0f172a;
  color: #e5e7eb;
  font-family: system-ui, sans-serif;
  height: 100vh;
}

/* -------------------------
   TITLE SCREEN
-------------------------- */
#titleScreen {
  position: fixed;
  inset: 0;
  background: url("TITLE_BG.jpg") center / cover no-repeat;
  display: flex;
  align-items: center;
  justify-content: center;
}

#titleOverlay {
  background: rgba(15, 23, 42, 0.75);
  padding: 40px;
  border-radius: 16px;
  text-align: center;
}

#titleLogo {
  width: 280px;
  max-width: 80vw;
  margin-bottom: 24px;
}

button {
  padding: 14px 36px;
  font-size: 1.1rem;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  background: #38bdf8;
  color: #020617;
}

button:hover {
  opacity: 0.9;
}

#copyright {
  margin-top: 18px;
  font-size: 0.85rem;
  opacity: 0.7;
}

/* -------------------------
   GAME
-------------------------- */
#gameContainer {
  display: none;
  height: 100vh;
  background: #0f172a;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.hud {
  margin: 12px;
  height: 24px;
}

.game {
  display: grid;
  gap: 6px;
}

.tile {
  width: 70px;
  height: 70px;
  background: #1e293b;
  border-radius: 8px;
  cursor: pointer;
  display: flex;
  justify-content: center;
  align-items: center;
}

svg {
  width: 50px;
  height: 50px;
}

.pipe {
  stroke: #cbd5f5;
  stroke-width: 10;
  stroke-linecap: round;
  fill: none;
}

.water {
  stroke: #38bdf8;
  stroke-width: 6;
  stroke-linecap: round;
  fill: none;
  stroke-dasharray: 12;
  animation: flow 1s linear infinite;
}

@keyframes flow {
  to { stroke-dashoffset: -24; }
}

/* -------------------------
   OVERLAY
-------------------------- */
.overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.8);
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 2rem;
}

.hidden {
  display: none;
}
</style>
</head>

<body>

<!-- TITLE SCREEN -->
<div id="titleScreen">
  <div id="titleOverlay">
    <img id="titleLogo" src="LOGO.png" alt="Rotate the Pipes">
    <button id="playBtn">Play</button>
    <div id="copyright">Â© Stenoip Company</div>
  </div>
</div>

<!-- GAME -->
<div id="gameContainer">
  <div class="hud" id="hud"></div>
  <div class="game" id="game"></div>
</div>

<div class="overlay hidden" id="overlay"></div>

<script>
/* -------------------------
   SAVE
-------------------------- */
var level = parseInt(localStorage.getItem("pipeLevel")) || 1;

/* -------------------------
   STATE
-------------------------- */
var SIZE = 4;
var tiles = [];
var timer = null;
var timeLeft = 0;
var won = false;

var game = document.getElementById("game");
var hud = document.getElementById("hud");
var overlay = document.getElementById("overlay");
var titleScreen = document.getElementById("titleScreen");
var gameContainer = document.getElementById("gameContainer");

var OPPOSITE = [2, 3, 0, 1];

/* -------------------------
   DIFFICULTY
-------------------------- */
function levelSettings() {
  SIZE = Math.min(7, 4 + Math.floor(level / 3));
  timeLeft = (level > 2 && level % 3 === 0) ? 20 + SIZE * 2 : 0;
}

/* -------------------------
   SOLVED BOARD
-------------------------- */
function createSolvedBoard() {
  tiles = [];

  for (var i = 0; i < SIZE * SIZE; i++) {
    tiles.push({ c: [0, 0, 0, 0] });
  }

  for (var y = 0; y < SIZE; y++) {
    for (var x = 0; x < SIZE; x++) {
      var index = y * SIZE + x;
      var tile = tiles[index];

      if (x < SIZE - 1 && Math.random() < 0.85) {
        tile.c[1] = 1;
        tiles[index + 1].c[3] = 1;
      }

      if (y < SIZE - 1 && Math.random() < 0.85) {
        tile.c[2] = 1;
        tiles[index + SIZE].c[0] = 1;
      }
    }
  }
}

/* -------------------------
   SCRAMBLE
-------------------------- */
function scramble() {
  for (var i = 0; i < tiles.length; i++) {
    var spins = Math.floor(Math.random() * 4);
    for (var j = 0; j < spins; j++) rotate(tiles[i]);
  }
}

/* -------------------------
   RENDER
-------------------------- */
function render() {
  game.innerHTML = "";
  game.style.gridTemplateColumns = "repeat(" + SIZE + ", 70px)";
  hud.textContent = "Level " + level;

  for (var i = 0; i < tiles.length; i++) {
    (function(i) {
      var tile = tiles[i];
      var div = document.createElement("div");
      div.className = "tile";
      div.innerHTML = pipeSVG(tile.c, false);
      div.onclick = function () {
        if (won) return;
        rotate(tile);
        check();
      };
      game.appendChild(div);
    })(i);
  }

  check();
}

/* -------------------------
   SVG
-------------------------- */
function pipeSVG(c, water) {
  var d = "";
  if (c[0]) d += "M25 25 L25 0 ";
  if (c[1]) d += "M25 25 L50 25 ";
  if (c[2]) d += "M25 25 L25 50 ";
  if (c[3]) d += "M25 25 L0 25 ";

  return '<svg viewBox="0 0 50 50">' +
         '<path class="pipe" d="' + d + '"/>' +
         (water ? '<path class="water" d="' + d + '"/>' : '') +
         '</svg>';
}

/* -------------------------
   LOGIC
-------------------------- */
function rotate(tile) {
  tile.c.unshift(tile.c.pop());
}

function check() {
  var divs = document.querySelectorAll(".tile");
  var success = true;

  for (var i = 0; i < tiles.length; i++) {
    var tile = tiles[i];
    var x = i % SIZE;
    var y = Math.floor(i / SIZE);
    var ok = true;

    for (var d = 0; d < 4; d++) {
      if (!tile.c[d]) continue;

      var nx = x;
      var ny = y;
      if (d === 0) ny--;
      if (d === 1) nx++;
      if (d === 2) ny++;
      if (d === 3) nx--;

      if (nx < 0 || ny < 0 || nx >= SIZE || ny >= SIZE ||
          !tiles[ny * SIZE + nx].c[OPPOSITE[d]]) {
        ok = false;
      }
    }

    divs[i].innerHTML = pipeSVG(tile.c, ok);
    if (!ok) success = false;
  }

  if (success && !won) win();
}

/* -------------------------
   TIMER
-------------------------- */
function startTimer() {
  clearInterval(timer);
  if (!timeLeft) return;

  timer = setInterval(function () {
    timeLeft--;
    if (timeLeft <= 0) lose();
  }, 1000);
}

/* -------------------------
   WIN / LOSE
-------------------------- */
function win() {
  won = true;
  clearInterval(timer);
  localStorage.setItem("pipeLevel", level + 1);

  overlay.textContent = "Level Complete";
  overlay.classList.remove("hidden");

  setTimeout(function () {
    level++;
    startLevel();
  }, 1500);
}

function lose() {
  clearInterval(timer);
  localStorage.setItem("pipeLevel", 1);
  level = 1;

  overlay.textContent = "Game Over";
  overlay.classList.remove("hidden");

  setTimeout(startLevel, 1500);
}

/* -------------------------
   FLOW
-------------------------- */
function startLevel() {
  overlay.classList.add("hidden");
  won = false;
  levelSettings();
  createSolvedBoard();
  scramble();
  render();
  startTimer();
}

document.getElementById("playBtn").onclick = function () {
  titleScreen.style.display = "none";
  gameContainer.style.display = "flex";
  startLevel();
};
</script>

</body>
</html>
